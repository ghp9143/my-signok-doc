<!DOCTYPE html>
<html lang="ko">
    <head>
        <script src="./js/loadHTML.js"></script>
        <script>
            loadHTML("./include/head.html");
        </script>
        <title>문서목록</title>
    </head>

    <body>
        <!-- tutorial -->
        <div id="tutorial-wrap">
            <div class="tutorial__area">
                <div class="tutorial__box">
                    <p>
                        선택한 계약서의 전체 이력 조회 및 문서의 변경사항을 한눈에 확인할 수 있는 창입니다.
                    </p>
                    <div class="flex--row flex-justify--between">
                        <button type="button" class="button button--primary button--small">다음</button>
                    </div>
                </div>
                <div class="tutorial__box">
                    <p>
                        완료된 계약서와 문서 이력내용을 모두 다운로드 하실 수 있습니다. 
                    </p>
                    <div class="flex--row flex-justify--between">
                        <button type="button" class="button button--outline button--small">이전</button>
                        <button type="button" class="button button--primary button--small">다음</button>
                    </div>
                </div>
                <div class="tutorial__box">
                    <p>
                        완료된 계약서 및 이력정보를 다운로드 시 TSA도 포함됩니다.
                    </p>
                    <div class="flex--row flex-justify--between">
                        <button type="button" class="button button--outline button--small">이전</button>
                        <button type="button" class="button button--primary button--small">종료</button>
                    </div>
                </div>
            </div>
        </div>
        <!-- / tutorial -->

        <script>
            loadHTML("./include/nav.html");
        </script>
        
        <main class="main">
            <!-- 상단 헤더 -->
            <script>
                loadHTML("./include/sub_header.html");
            </script>
            
            <!-- // 상단헤더 -->
            <div class="container flex--row">
                <!-- 메인 컨텐츠 -->
                <div id="main-content">

                    <!-- 상단 -->
                    <div class="flex--row">
                        <button type="button" class="button button--regular button--outline"
                        id="change-folder">
                            폴더선택
                        </button>
    
                        <div id="count_load_table" class="select-box select-box--large">
                            <select class="select-box__select">
                                <option value="10" selected>10개씩 보기</option>
                                <option value="30">30개씩 보기</option>
                                <option value="50">50개씩 보기</option>
                            </select>
                            <img class="select-box__icon icon" src="./icon/angle-line.svg" alt="화살표">
                        </div>
                    </div>
                   
                    <!-- 상단 2 -->
                    <div class="flex--row flex-justify--between flex-align--center">
                        <ul class="tab flex--row">
                            <li class="tab__item is-active">전체</li>
                            <li class="tab__item">완료</li>
                            <li class="tab__item">진행중</li>
                            <li class="tab__item">만료</li>
                        </ul>
                        <button type="button" class="button button--regular">엑셀로 내려받기</button>
                    </div>

                    
                    <!-- 컨텐츠 테이블 (for문 생성) -->
                    <ul class="table">
                        <ul class="table__tr">
                            <li class="table__thead">
                                <input type="checkbox" class="checkbox"
                                id="checkbox-all">
                            </li>
                            <li class="table__thead">상태</li>
                            <li class="table__thead">문서이름</li>
                            <li class="table__thead">알람</li>
                            <li class="table__thead">위치</li>
                            <li class="table__thead">마지막 활동시간</li>
                            <li class="table__thead">추가메뉴</li>
                        </ul>
                    <ul class="table__tbody">
                </div>

               <!-- 사이드 컨텐츠 (이벤트 때 생성) -->
                <div id="aside-content" class="container">
                    <h5>문서 이력</h5>
                    <ul>
                        <li>
                            <p>hong12</p>
                            <p>(hong1234@naver.com)</p>
                            <p>서명 2022-12-12 16:50</p>
                        </li>
                    </ul>
                    <button type="button">전체 진행정보 보기</button>
                    <button type="button">계약서 내용 확인하기</button>
                </div>
            </div>
        </main>
        <script>
             $(function(){
                loadData()
            })

            $('#count_load_table').on('change',loadData)

            function loadData(){
                $.ajax({
                    url: "/json/dummy.json",
                    type: "GET", 
                    dataType: "json"
                })
                .done(function(res) {
                    makeTable(res)
                })
                .fail(function(xhr, status, errorThrown) {
                })
                .always(function(xhr, status) {
                });
            }

            function makeTable(data){
                const count = Number($('#count_load_table option:selected').val())
                if($('.table__tbody .table__tr').length > 0) {
                    $('.table__tbody .table__tr').remove()
                }
                for (let i = 0; i < count; i++){
                    let friends = [];
                    for(let a = 0; a < data[i].friends.length; a++){
                        friends.push(data[i].friends[a].name)
                    }

                    if(data[i].isActive == false){
                        state = '만료'
                    }
                    else{
                        state = '진행중'
                    }

                    html = ''
                    html += `
                    <ul class="table__tr" data-id="${data[i]._id}">
                        <li class="table__td state active">
                            <input type="checkbox" class="checkbox"
                            id="">
                        </li>
                        <li class="table__td state active">
                            <img src="">
                            ${state}
                        </li>
                        <li class="table__td font-weight--medium">
                            <span class="document-title">${data[i].guid}</span>
                            <ul>
                                <li class="table__td--remark">${friends}</li>
                            </ul>
                        </li>
                        <li class="table__td">
                            <label class="toggle">
                                <input type="checkbox" class="toggle__checkbox">
                                <span class="toggle__slider"></span>
                            </label>
                        </li>
                        <li class="table__td table__td--remark">기본 폴더</li>
                        <li class="table__td table__td--remark">${data[i].registered}</li>
                        <li class="table__td">
                            <button type="button" class="button button--outline icon-button button--small">
                                <img class="icon" src="/icon/ellipsis-horizontal-line.svg">
                            </button>
                        </li>
                    </ul>
                    `
                    $('.table__tbody').append(html)
                }
            }

            $('#tutorial-wrap').hide()


            // 전체 동의
            function manageAllCheck(){
                $(this).prop('checked')==true ?
                $('.checkbox').prop('checked',true) :
                $('.checkbox').prop('checked',false)
            }

            $('#checkbox-all').on('click',manageAllCheck)


            /**
             * 폴더 변경: no-filter. api data 전송g하고 makeTable() 실행
             * 
            */

            // 폴더변경 클릭
            $('#change-folder').on('click',makeFolderModal)
            function makeFolderModal(){

            html = '';
                html += `
                <div class="modal">
                    <div class="modal__header">
                        <p class="modal__title">
                            <img src="/icon/exclamation-triangle-line.svg" alt="닫기" class="icon icon--large icon--warning">
                            폴더 선택
                        </p>
                        <button type="button" class="icon-button">
                            <img src="/icon/close-line.svg" alt="닫기" class="icon modal__close-button">
                        </button>
                    </div>
                    <div class="modal__content">
                        <div class="modal__search-form">
                            <input type="text" class="input input--large"
                            placeholder="검색어를 입력해주세요">
                            <img class="icon icon" src="./icon/search-line.svg" alt="검색">
                        </div>
                        <ul class="modal__list">
                            <li class="felx--row flex-align--center is-active"> 
                                <img class="icon " src="./icon/folder-open-solid.svg" alt="현재폴더">
                                전체 폴더 보기
                            </li>
                            <li class="felx--row flex-align--center"> 
                                <img class="icon " src="./icon/folder-line.svg" alt="현재폴더">
                                기본 폴더
                            </li>
                            <li class="felx--row flex-align--center"> 
                                <img class="icon " src="./icon/folder-line.svg" alt="현재폴더">
                                기존 사용 서식
                            </li>
                        </ul>
                    </div>
                    <div class="modal__button-wrap">
                        <button type="button" class="button--primary button--large"
                        id="create-new-folder">새 폴더 추가하기</button>
                    </div>
                </div>
                `
                $('.main').append(html)
            }

            $(document).on('click','#create-new-folder',createNewFolder)
            function createNewFolder(){
                html = '';
                html += `
                    <div class="flex--row">
                        <input type="text" class="input">
                        <button type="button" id="cancel-new-folder">취소</button>
                        <button type="button" id="submit-new-folder">완료</button>
                    </div>
                `
                $('.modal__list').append(html)

                $('#cancel-new-folder').on('click',function(){
                    $(this).parents('.flex--row').remove()
                })
                $('#submit-new-folder').on('click',function(){
                    if($(this).siblings('.input').val().length < 1){
                        alert('폴더명을 입력해주세요')
                    }
                    else{
                        $(this).parents('.flex--row').remove()
                        $('.modal__list').append(`
                            <li class="felx--row flex-align--center"> 
                                <img class="icon " src="./icon/folder-line.svg" alt="현재폴더">
                                ${$(this).siblings('.input').val()}
                            </li>
                        `)
                    }
                })
            }

            
            
            function changeFolder(){
                $.ajax({
                    url: "/json/dummy.json",
                    type: "GET", 
                    data:{},
                    dataType: "json"
                })
                .done(function(res) {
                    makeTable(res)
                })
                .fail(function(xhr, status, errorThrown) {
                })
                .always(function(xhr, status) {
                });
            }

            // 더보기 버튼 클릭
            function makeMoreEvent(){
                const documentId =$(this).attr('data-id')
                html = '';
                html += `
                <ul class="table__modal">
                    <li id="document-name-change">문서이름변경</li>
                    <li id="document-download">다운로드</li>
                    <li id="document-move">폴더이동</li>
                    <li id="document-delete">삭제</li>
                </ul>
                `
                $('.table__modal').length < 1 ? $(this).append(html):$('.table__modal').remove()

                $('#document_name_change').on('click',alertDelete)
                $('#document_download').on('click',alertDelete)
                $('#document_move').on('click',alertDelete)
                $('#document_delete').on('click',alertDelete)
            }

            $(document).on('click','.table__tbody .table__tr .button--outline',makeMoreEvent)

            // 삭제 이벤트
            function alertDelete(){
                const documentTitle = $(this).parents('.table__tr').find('.document-title').text()
                html = '';
                html += `
                <div class="modal">
                    <div class="modal__header">
                        <p class="modal__title">
                            <img src="/icon/exclamation-triangle-line.svg" alt="닫기" class="icon icon--large icon--warning">
                            휴지통으로 보내기
                        </p>
                        <button type="button" class="icon-button">
                            <img src="/icon/close-line.svg" alt="닫기" class="icon modal__close-button">
                        </button>
                    </div>
                    <div class="modal__content">
                        <span class="font-weight--medium">${documentTitle}</span>
                        를 휴지통으로 보낼까요?
                    </div>
                    <div class="modal__button-wrap">
                        <button type="button" class="button--primary button--large">확인</button>
                    </div>
                </div>
                `
                $('.main').append(html)
            }

            

        </script>
        <script src="./js/tutorial.js"></script>
        <script src="./js/common.js"></script>
    </body>
    
</html>